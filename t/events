#!/bin/bash
source ${srcdir:-.}/t/lib
need_command z{push,dealer}
tmpfs

for dir in etc var out log; do
	mkdir -p ${ROOT}/${dir}
done

LISTENER="ipc://${ROOT}/bolo.listener.sock"
CONTROLLER="ipc://${ROOT}/bolo.controller.sock"
BROADCAST="ipc://${ROOT}/bolo.broadcast.sock"

cat <<EOF >${ROOT}/etc/bolo.conf
listener   ${LISTENER}
controller ${CONTROLLER}
broadcast  ${BROADCAST}

log debug console

savefile   ${ROOT}/var/savedb
keysfile   ${ROOT}/var/keysdb

max.events 3
EOF

./bolo -Fc ${ROOT}/etc/bolo.conf > ${ROOT}/log/bolo 2>&1 &
BOLO_PID=$!
clean_pid ${BOLO_PID}
diag_file ${ROOT}/log/bolo

TS=$(date +%s)
ZTK_OPTS="--timeout 200"
sleep 1
echo "EVENT|$TS|event.1|server bucko powered on"   | zpush ${ZTK_OPTS} -c ${LISTENER}

string_is "$(echo "GET.EVENTS|$(( TS - 1 ))" | zdealer ${ZTK_OPTS} -c ${CONTROLLER})" \
"EVENTS|---
# generated by bolo
- name:  event.1
  when:  $TS
  extra: server bucko powered on" \
          "retrieved events (1/1)"

echo "EVENT|$(( TS + 1 ))|event.2|server bucko shut down" | zpush ${ZTK_OPTS} -c ${LISTENER}
string_is "$(echo "GET.EVENTS|$(( TS - 1 ))" | zdealer ${ZTK_OPTS} -c ${CONTROLLER})" \
"EVENTS|---
# generated by bolo
- name:  event.1
  when:  $TS
  extra: server bucko powered on
- name:  event.2
  when:  $(( TS + 1 ))
  extra: server bucko shut down" \
          "retrieved events (2/2)"

echo "EVENT|$(( TS + 2 ))|event.3|server bucko rebooted" | zpush ${ZTK_OPTS} -c ${LISTENER}
string_is "$(echo "GET.EVENTS|$(( TS - 1 ))" | zdealer ${ZTK_OPTS} -c ${CONTROLLER})" \
"EVENTS|---
# generated by bolo
- name:  event.1
  when:  $TS
  extra: server bucko powered on
- name:  event.2
  when:  $(( TS + 1 ))
  extra: server bucko shut down
- name:  event.3
  when:  $(( TS + 2 ))
  extra: server bucko rebooted" \
          "retrieved events (3/3)"

echo "EVENT|$(( TS + 3 ))|event.4|server bucko crashed HARD" | zpush ${ZTK_OPTS} -c ${LISTENER}
string_is "$(echo "GET.EVENTS|$(( TS - 1 ))" | zdealer ${ZTK_OPTS} -c ${CONTROLLER})" \
"EVENTS|---
# generated by bolo
- name:  event.2
  when:  $(( TS + 1))
  extra: server bucko shut down
- name:  event.3
  when:  $(( TS + 2))
  extra: server bucko rebooted
- name:  event.4
  when:  $(( TS + 3))
  extra: server bucko crashed HARD" \
          "retrieved events (3/4)"

kill -TERM ${BOLO_PID}

exit 0
